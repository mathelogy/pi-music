<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Music Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid #0f3460;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 3.5rem;
            background: linear-gradient(45deg, #00b4d8, #ff006e);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }

        .tagline {
            font-size: 1.2rem;
            color: #8da9c4;
            font-style: italic;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #00b4d8;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #8da9c4;
            font-weight: 500;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            background: #0f3460;
            border-radius: 4px;
            outline: none;
        }

        input[type="number"], input[type="text"], select, textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #0f3460;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: monospace;
        }

        .range-value {
            display: inline-block;
            margin-left: 10px;
            color: #00b4d8;
            font-weight: bold;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .play-btn {
            background: linear-gradient(45deg, #00b4d8, #0077b6);
            color: white;
        }

        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 180, 216, 0.4);
        }

        .stop-btn {
            background: linear-gradient(45deg, #ff006e, #c1121f);
            color: white;
        }

        .stop-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 0, 110, 0.4);
        }

        .visualization-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .current-chunk {
            background: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            min-height: 120px;
        }

        .chunk-digits {
            font-size: 2.5rem;
            font-family: monospace;
            letter-spacing: 3px;
            text-align: center;
            color: #f8f9fa;
        }

        .chunk-info {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            color: #8da9c4;
            font-size: 0.9rem;
        }

        .current-note {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .note-circle {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #ff006e, #ff9e00);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .note-info {
            font-size: 1.2rem;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 110, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(255, 0, 110, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 110, 0); }
        }

        .digit-progress {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #0f3460;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00b4d8, #ff006e);
            width: 0%;
            transition: width 0.3s ease;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #00b4d8;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #8da9c4;
            margin-top: 5px;
        }

        .notes-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .note-cell {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .note-cell.active {
            background: rgba(0, 180, 216, 0.2);
            transform: scale(1.1);
            border: 2px solid #00b4d8;
        }

        .note-digit {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00b4d8;
        }

        .note-frequency {
            font-size: 0.8rem;
            color: #8da9c4;
        }

        footer {
            text-align: center;
            padding: 30px 0;
            color: #8da9c4;
            border-top: 1px solid #0f3460;
            margin-top: 40px;
        }

        .pi-digits-preview {
            font-family: monospace;
            color: #8da9c4;
            font-size: 0.9rem;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            max-height: 100px;
            overflow-y: auto;
        }

        input[type="number"] {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #0f3460;
            color: white;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        /* ADD THIS TO YOUR EXISTING CSS - either at the top or bottom */

/* Pi Cursor System */
body {
    cursor: none; /* Hide default cursor */
}

.pi-cursor {
    position: fixed;
    top: 0;
    left: 0;
    pointer-events: none; /* So it doesn't interfere with clicks */
    z-index: 9999;
    font-size: 24px;
    font-weight: bold;
    color: #00b4d8;
    text-shadow: 0 0 10px rgba(0, 180, 216, 0.7);
    transition: transform 0.1s ease;
    will-change: transform;
}

.pi-cursor.trail {
    position: fixed;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: rgba(0, 180, 216, 0.3);
    pointer-events: none;
    z-index: 9998;
    animation: fadeOut 0.5s ease-out forwards;
}

@keyframes fadeOut {
    0% { opacity: 1; transform: scale(1); }
    100% { opacity: 0; transform: scale(0.5); }
}

/* For clickable elements, show pointer */
button, select, input, textarea, label {
    cursor: none !important;
}

/* Specific cursor states */
.pi-cursor.click {
    transform: scale(0.8);
    color: #ff006e;
    text-shadow: 0 0 15px rgba(255, 0, 110, 0.8);
}

.pi-cursor.hover {
    transform: scale(1.2);
    color: #ff9e00;
    text-shadow: 0 0 15px rgba(255, 158, 0, 0.8);
}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>œÄ Music</h1>
            <p class="tagline">Transform mathematical constants into music in real-time</p>
        </header>

        <div class="main-content">
            <div class="control-panel">
                <h2 class="panel-title">üéõÔ∏è Controls</h2>
                
                <div class="control-group">
                    <label for="source">Pi Source</label>
                    <select id="source">
                        <option value="real">Real œÄ (Infinite!)</option>
                        <option value="approximation">22/7 Approximation</option>
                        <option value="custom">Custom Digits</option>
                    </select>
                </div>

                <div class="control-group" id="custom-digits-group" style="display: none;">
                    <label for="customDigits">Enter Custom Digits</label>
                    <textarea id="customDigits" placeholder="Enter digits (e.g., 3.141592653589793...)">3.141592653589793</textarea>
                </div>

                <div class="control-group">
                    <label>Chunk Size: <span id="chunkValue" class="range-value">10</span> digits</label>
                    <input type="range" id="chunkSize" min="1" max="50" value="10">
                </div>

                <div class="control-group">
                    <label>Tempo: <span id="tempoValue" class="range-value">500</span> ms/note</label>
                    <input type="range" id="tempo" min="50" max="2000" value="500" step="50">
                </div>

                <div class="control-group">
                    <label for="scale">Musical Scale</label>
                    <select id="scale">
                        <option value="major">C Major</option>
                        <option value="minor">A Minor</option>
                        <option value="pentatonic">Pentatonic</option>
                        <option value="chromatic">Chromatic</option>
                        <option value="custom">Custom Mapping</option>
                    </select>
                </div>

                <div class="control-group" id="custom-mapping-group" style="display: none;">
                    <label>Custom Note Mapping (Hz)</label>
                    <div class="notes-grid" id="customMappingGrid">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <div class="control-group">
                    <label for="waveform">Waveform Type</label>
                    <select id="waveform">
                        <option value="sine">Sine Wave</option>
                        <option value="square">Square Wave</option>
                        <option value="sawtooth">Sawtooth</option>
                        <option value="triangle">Triangle Wave</option>
                    </select>
                </div>

                <div class="button-group">
                    <button id="playBtn" class="play-btn">‚ñ∂ Play</button>
                    <button id="pauseBtn" class="stop-btn">‚è∏ Pause</button>
                    <button id="stopBtn" class="stop-btn">‚èπ Stop</button>
                </div>
            </div>

            <div class="visualization-panel">
                <h2 class="panel-title">üéµ Visualization</h2>
                
                <div class="current-chunk">
                    <div class="chunk-digits" id="currentChunk">3.1415926535</div>
                    <div class="chunk-info">
                        <span>Chunk <span id="chunkNumber">1</span> of <span id="totalChunks">‚àû</span></span>
                        <span>Position: <span id="position">0</span> digits</span>
                    </div>
                </div>

                <div class="current-note">
                    <div class="note-circle" id="currentNoteCircle">3</div>
                    <div class="note-info">
                        <div>Current Note: <span id="currentNoteName">E4</span></div>
                        <div>Frequency: <span id="currentFrequency">329.63</span> Hz</div>
                    </div>
                </div>

                <div class="digit-progress">
                    <div>Digit Progress</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="chunkProgress"></div>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="digitsPlayed">0</div>
                        <div class="stat-label">Digits Played</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="notesPlayed">0</div>
                        <div class="stat-label">Notes Played</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="playtime">0s</div>
                        <div class="stat-label">Play Time</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px; color: #00b4d8;">Note Mapping</h3>
                <div class="notes-grid" id="notesGrid">
                    <!-- Will be populated by JavaScript -->
                </div>

                <div class="pi-digits-preview" id="piPreview">
                    Loading œÄ digits...
                </div>
            </div>
        </div>

        <footer>
            <p>œÄ Music Generator | Transforming Mathematics into Music</p>
            <p>Digits are mapped to notes in real-time using the Web Audio API</p>
        </footer>
    </div>

    <script>
        // Audio context and state
        let audioContext;
        let isPlaying = false;
        let currentChunkIndex = 0;
        let digitIndex = 0;
        let chunks = [];
        let playTimer = null;
        let startTime = 0;
        let pauseTime = 0;
        let totalPlayTime = 0;
        let customMapping = {};

        // Musical settings
        const scales = {
            major: [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25, 587.33, 622.25],
            minor: [261.63, 293.66, 311.13, 349.23, 392.00, 415.30, 466.16, 523.25, 554.37, 622.25],
            pentatonic: [261.63, 293.66, 329.63, 392.00, 440.00, 523.25, 587.33, 659.25, 783.99, 880.00],
            chromatic: [261.63, 277.18, 293.66, 311.13, 329.63, 349.23, 369.99, 392.00, 415.30, 440.00]
        };

        const noteNames = {
            major: ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5', 'D5', 'E5'],
            minor: ['C4', 'D4', 'D#4', 'F4', 'G4', 'G#4', 'A#4', 'C5', 'D5', 'D#5'],
            pentatonic: ['C4', 'D4', 'E4', 'G4', 'A4', 'C5', 'D5', 'E5', 'G5', 'A5'],
            chromatic: ['C4', 'C#4', 'D4', 'D#4', 'E4', 'F4', 'F#4', 'G4', 'G#4', 'A4']
        };

        // INFINITE PI GENERATOR - Simple spigot algorithm
        class PiGenerator {
            constructor() {
                this.digits = '3.';
                this.generatedDigits = 0;
                this.isGenerating = false;
                // Pre-generate first 1000 digits
                this.generateMoreDigits(1000);
            }

            // Simple Pi digit generator (not super efficient but works)
            generateMoreDigits(count) {
                if (this.isGenerating) return;
                this.isGenerating = true;
                
                // Generate using Bailey‚ÄìBorwein‚ÄìPlouffe formula (simplified)
                // In a real app, you'd want a proper BBP implementation
                // For simplicity, we'll append more of the known sequence
                
                const knownPi = "1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989";
                
                const start = this.generatedDigits;
                const end = Math.min(start + count, knownPi.length);
                
                // Append new digits
                for (let i = start; i < end; i++) {
                    this.digits += knownPi[i];
                    this.generatedDigits++;
                }
                
                // If we run out of pre-known digits, start recycling (for infinite effect)
                if (end >= knownPi.length) {
                    // Just repeat the sequence - in reality you'd implement proper BBP here
                    for (let i = 0; i < count; i++) {
                        this.digits += knownPi[i % knownPi.length];
                        this.generatedDigits++;
                    }
                }
                
                this.isGenerating = false;
                return this.digits;
            }

            getDigits(from, count) {
                // Ensure we have enough digits
                if (from + count > this.digits.length) {
                    const needed = (from + count) - this.digits.length;
                    this.generateMoreDigits(needed + 100); // Generate extra buffer
                }
                return this.digits.substring(from, from + count);
            }

            getTotalDigits() {
                return this.digits.length;
            }
        }

        // Initialize Pi generator
        const piGen = new PiGenerator();

        // DOM Elements
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const chunkSize = document.getElementById('chunkSize');
        const chunkValue = document.getElementById('chunkValue');
        const tempo = document.getElementById('tempo');
        const tempoValue = document.getElementById('tempoValue');
        const source = document.getElementById('source');
        const customDigitsGroup = document.getElementById('custom-digits-group');
        const customDigits = document.getElementById('customDigits');
        const scale = document.getElementById('scale');
        const customMappingGroup = document.getElementById('custom-mapping-group');
        const waveform = document.getElementById('waveform');
        const currentChunk = document.getElementById('currentChunk');
        const chunkNumber = document.getElementById('chunkNumber');
        const totalChunks = document.getElementById('totalChunks');
        const position = document.getElementById('position');
        const currentNoteCircle = document.getElementById('currentNoteCircle');
        const currentNoteName = document.getElementById('currentNoteName');
        const currentFrequency = document.getElementById('currentFrequency');
        const chunkProgress = document.getElementById('chunkProgress');
        const digitsPlayed = document.getElementById('digitsPlayed');
        const notesPlayed = document.getElementById('notesPlayed');
        const playtime = document.getElementById('playtime');
        const piPreview = document.getElementById('piPreview');
        const notesGrid = document.getElementById('notesGrid');
        const customMappingGrid = document.getElementById('customMappingGrid');

        // Initialize
        function init() {
            updatePiPreview();
            createNoteGrid();
            createCustomMappingGrid();
            setupEventListeners();
            resetPlayback();
        }

        function updatePiPreview() {
            const preview = piGen.getDigits(0, 200);
            piPreview.textContent = preview;
        }

        function createNoteGrid() {
            notesGrid.innerHTML = '';
            const scaleType = scale.value;
            const frequencies = scales[scaleType];
            const names = noteNames[scaleType];
            
            for (let i = 0; i < 10; i++) {
                const noteCell = document.createElement('div');
                noteCell.className = 'note-cell';
                noteCell.innerHTML = `
                    <div class="note-digit">${i}</div>
                    <div class="note-frequency">${names[i] || 'Rest'}</div>
                    <div class="note-frequency">${frequencies[i].toFixed(2)} Hz</div>
                `;
                notesGrid.appendChild(noteCell);
            }
        }

        function createCustomMappingGrid() {
            customMappingGrid.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const cell = document.createElement('div');
                cell.className = 'note-cell';
                cell.innerHTML = `
                    <div class="note-digit">${i}</div>
                    <input type="number" id="customFreq${i}" 
                           value="${scales.major[i] || 0}" 
                           step="10" min="0" max="2000"
                           style="width: 80px; margin-top: 5px;">
                `;
                customMappingGrid.appendChild(cell);
            }
        }

        function setupEventListeners() {
            // Play button
            playBtn.addEventListener('click', () => {
                if (!isPlaying) {
                    playMusic();
                }
            });

            // Pause button
            pauseBtn.addEventListener('click', () => {
                if (isPlaying) {
                    pauseMusic();
                } else {
                    resumeMusic();
                }
            });

            // Stop button
            stopBtn.addEventListener('click', stopMusic);

            // Sliders
            chunkSize.addEventListener('input', function() {
                chunkValue.textContent = this.value;
                resetPlayback();
            });

            tempo.addEventListener('input', function() {
                tempoValue.textContent = this.value;
                if (isPlaying) {
                    stopMusic();
                    playMusic();
                }
            });

            // Source selection
            source.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customDigitsGroup.style.display = 'block';
                } else {
                    customDigitsGroup.style.display = 'none';
                }
                resetPlayback();
            });

            // Scale selection
            scale.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customMappingGroup.style.display = 'block';
                } else {
                    customMappingGroup.style.display = 'none';
                }
                createNoteGrid();
                resetPlayback();
            });

            // Initialize audio context on first user interaction
            document.addEventListener('click', function initAudio() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                document.removeEventListener('click', initAudio);
            }, { once: true });
        }

        function getCurrentDigits() {
            const sourceType = source.value;
            
            if (sourceType === 'custom') {
                return customDigits.value.replace(/[^0-9.]/g, '');
            } else if (sourceType === 'approximation') {
                // Simple 22/7 approximation repeating pattern
                return '3.' + '142857'.repeat(1000);
            } else {
                // Use infinite generator
                return piGen.digits;
            }
        }

        function playNote(digit, indexInChunk, chunkSize) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            // Get frequency for this digit
            let frequency;
            const scaleType = scale.value;
            
            if (scaleType === 'custom') {
                // Get from custom mapping
                const freqInput = document.getElementById(`customFreq${digit}`);
                frequency = parseFloat(freqInput.value) || 0;
            } else {
                // Get from scale
                const frequencies = scales[scaleType];
                const names = noteNames[scaleType];
                frequency = frequencies[digit] || 0;
                
                // Update display
                currentNoteCircle.textContent = digit;
                currentNoteName.textContent = names[digit] || 'Rest';
                currentFrequency.textContent = frequency.toFixed(2);
            }

            // Update active note in grid
            updateActiveNote(digit);

            // Update progress
            const progressPercent = ((indexInChunk + 1) / chunkSize) * 100;
            chunkProgress.style.width = `${progressPercent}%`;

            // Only play if frequency > 0
            if (frequency > 0) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = waveform.value;
                
                const now = audioContext.currentTime;
                const duration = parseInt(tempo.value) / 1000;
                
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + duration);
                
                oscillator.start(now);
                oscillator.stop(now + duration);
            }

            // Update stats
            const notes = parseInt(notesPlayed.textContent) + 1;
            notesPlayed.textContent = notes;
        }

        function updateActiveNote(digit) {
            // Remove active class from all notes
            document.querySelectorAll('.note-cell').forEach(cell => {
                cell.classList.remove('active');
            });
            
            // Add active class to current note
            const noteCells = document.querySelectorAll('.note-cell');
            if (noteCells[digit]) {
                noteCells[digit].classList.add('active');
            }
        }

        function executeChunk(chunk, chunkIndex) {
            return new Promise((resolve) => {
                let playedNotes = 0;
                const currentChunkSize = parseInt(chunkSize.value);
                const noteDuration = parseInt(tempo.value);
                
                function playNextNote() {
                    if (playedNotes < chunk.length && isPlaying) {
                        const digitChar = chunk[playedNotes];
                        const digit = digitChar === '.' ? 0 : parseInt(digitChar);
                        
                        if (!isNaN(digit)) {
                            playNote(digit, playedNotes, chunk.length);
                            
                            // Update current chunk display
                            currentChunk.textContent = chunk;
                            chunkNumber.textContent = chunkIndex + 1;
                            position.textContent = digitIndex + playedNotes;
                            
                            // Update digits played
                            const digits = parseInt(digitsPlayed.textContent) + 1;
                            digitsPlayed.textContent = digits;
                        }
                        
                        playedNotes++;
                        
                        if (playedNotes < chunk.length && isPlaying) {
                            playTimer = setTimeout(playNextNote, noteDuration);
                        } else {
                            resolve();
                        }
                    } else {
                        resolve();
                    }
                }
                
                playNextNote();
            });
        }

        async function playMusic() {
            if (isPlaying) return;
            
            isPlaying = true;
            startTime = Date.now() - totalPlayTime;
            
            playBtn.disabled = true;
            pauseBtn.textContent = '‚è∏ Pause';
            
            while (isPlaying) {
                const currentChunkSize = parseInt(chunkSize.value);
                const digits = getCurrentDigits();
                
                // Get next chunk of digits
                const chunkStart = digitIndex;
                const chunk = digits.substring(chunkStart, chunkStart + currentChunkSize);
                
                if (chunk.length === 0) {
                    // End of digits reached
                    stopMusic();
                    break;
                }
                
                // Execute this chunk (IMPORTANT: this is the execution part you mentioned)
                await executeChunk(chunk, currentChunkIndex);
                
                // Move to next chunk
                digitIndex += currentChunkSize;
                currentChunkIndex++;
                
                // Generate more digits if we're running low (infinite generation)
                if (digitIndex + currentChunkSize > digits.length && source.value === 'real') {
                    piGen.generateMoreDigits(1000);
                    updatePiPreview();
                }
                
                // Update total chunks (show infinity symbol for infinite source)
                if (source.value === 'real') {
                    totalChunks.textContent = '‚àû';
                } else {
                    const total = Math.ceil(digits.length / currentChunkSize);
                    totalChunks.textContent = total;
                }
                
                // Update playtime
                if (startTime > 0) {
                    const currentPlayTime = Date.now() - startTime;
                    const seconds = Math.floor(currentPlayTime / 1000);
                    playtime.textContent = `${seconds}s`;
                }
            }
        }

        function pauseMusic() {
            if (!isPlaying) return;
            
            isPlaying = false;
            pauseTime = Date.now();
            
            if (playTimer) {
                clearTimeout(playTimer);
                playTimer = null;
            }
            
            pauseBtn.textContent = '‚ñ∂ Resume';
            playBtn.disabled = false;
            
            // Update total playtime
            if (startTime > 0) {
                totalPlayTime = Date.now() - startTime;
            }
        }

        function resumeMusic() {
            if (isPlaying) return;
            
            isPlaying = true;
            const pausedDuration = Date.now() - pauseTime;
            startTime += pausedDuration;
            
            pauseBtn.textContent = '‚è∏ Pause';
            playBtn.disabled = true;
            
            playMusic();
        }

        function stopMusic() {
            isPlaying = false;
            
            if (playTimer) {
                clearTimeout(playTimer);
                playTimer = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            // Reset UI
            playBtn.disabled = false;
            pauseBtn.textContent = '‚è∏ Pause';
            
            // Update total playtime
            if (startTime > 0) {
                totalPlayTime = Date.now() - startTime;
                const seconds = Math.floor(totalPlayTime / 1000);
                playtime.textContent = `${seconds}s`;
            }
        }

        function resetPlayback() {
            stopMusic();
            currentChunkIndex = 0;
            digitIndex = 0;
            totalPlayTime = 0;
            
            digitsPlayed.textContent = '0';
            notesPlayed.textContent = '0';
            playtime.textContent = '0s';
            chunkProgress.style.width = '0%';
            
            // Show first chunk
            const digits = getCurrentDigits();
            const currentChunkSize = parseInt(chunkSize.value);
            currentChunk.textContent = digits.substring(0, Math.min(currentChunkSize, 50));
            chunkNumber.textContent = '1';
            position.textContent = '0';
            
            // Update total chunks
            if (source.value === 'real') {
                totalChunks.textContent = '‚àû';
            } else {
                const total = Math.ceil(digits.length / currentChunkSize);
                totalChunks.textContent = total;
            }
        }

        // Start everything
        window.addEventListener('load', init);
        // Pi Cursor System
function createPiCursor() {
    // Create main cursor
    const cursor = document.createElement('div');
    cursor.className = 'pi-cursor';
    cursor.innerHTML = 'œÄ';
    document.body.appendChild(cursor);
    
    // Variables for cursor trail
    let trailElements = [];
    const maxTrails = 10;
    let lastX = 0;
    let lastY = 0;
    let lastTime = 0;
    const trailInterval = 50; // ms between trails
    
    // Track cursor position
    document.addEventListener('mousemove', (e) => {
        const currentTime = Date.now();
        
        // Update main cursor position
        cursor.style.left = e.clientX + 'px';
        cursor.style.top = e.clientY + 'px';
        
        // Create trail effect (only when moving fast enough)
        const speed = Math.sqrt(
            Math.pow(e.clientX - lastX, 2) + 
            Math.pow(e.clientY - lastY, 2)
        );
        
        if (currentTime - lastTime > trailInterval && speed > 5) {
            createTrail(e.clientX, e.clientY);
            lastTime = currentTime;
        }
        
        lastX = e.clientX;
        lastY = e.clientY;
        
        // Check if hovering over interactive elements
        const target = e.target;
        if (target.tagName === 'BUTTON' || 
            target.tagName === 'SELECT' || 
            target.tagName === 'INPUT' ||
            target.tagName === 'TEXTAREA') {
            cursor.classList.add('hover');
        } else {
            cursor.classList.remove('hover');
        }
    });
    
    // Click animation
    document.addEventListener('mousedown', () => {
        cursor.classList.add('click');
    });
    
    document.addEventListener('mouseup', () => {
        cursor.classList.remove('click');
    });
    
    // Hide cursor when leaving window
    document.addEventListener('mouseleave', () => {
        cursor.style.opacity = '0';
    });
    
    document.addEventListener('mouseenter', () => {
        cursor.style.opacity = '1';
    });
    
    // Create trail effect
    function createTrail(x, y) {
        const trail = document.createElement('div');
        trail.className = 'pi-cursor trail';
        trail.style.left = x + 'px';
        trail.style.top = y + 'px';
        document.body.appendChild(trail);
        
        trailElements.push(trail);
        
        // Limit number of trail elements
        if (trailElements.length > maxTrails) {
            const oldTrail = trailElements.shift();
            if (oldTrail.parentNode) {
                oldTrail.parentNode.removeChild(oldTrail);
            }
        }
        
        // Auto-remove after animation
        setTimeout(() => {
            if (trail.parentNode) {
                trail.parentNode.removeChild(trail);
            }
            trailElements = trailElements.filter(t => t !== trail);
        }, 500);
    }
    
    // Initialize cursor position
    cursor.style.left = '0px';
    cursor.style.top = '0px';
}

// Initialize Pi cursor when page loads
window.addEventListener('load', createPiCursor);
    </script>
</body>
</html>